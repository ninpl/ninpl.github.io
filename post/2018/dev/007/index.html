<!DOCTYPE html>
<html lang="es-es">
<head>
	<title>WebClient gestor de conexiones Unity3D&middot; Antonio Moon´s</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Moon Antonio">
	<meta name="description" content="un blog sobre mi, juegos, desarrollo y anime">
	<meta name="keywords" content="Moon,Antonio,Dev,Game">
	<meta name="generator" content="Hugo 0.41" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://moonantonio.github.io/css/main.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="https://moonantonio.github.io/favicon.ico" type="image/x-icon">

	

	<!-- Font Awesome -->
	<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
</head>

<body>
	<header class="site-header">
	<div class="branding">
		<a href="https://moonantonio.github.io/">
		<img class="avatar" src="https://moonantonio.github.io/img/avatar.png" alt="avatar"/>
		</a>
		<h1 class="site-title">
			<a href="https://moonantonio.github.io/">Antonio Moon´s</a>
		</h1>
	</div>
	<nav class="site-nav">

		<ul>
			<li><a href="/about/">  </a></li>

			<li class="list-group">
  <a class="list-group-item" href="https://github.com/MoonAntonio/rec.repos" title="Public">
  		</i>&nbsp; Publico</a> <i class="fa fa-code" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/about" title="About">
  		</i>&nbsp; About</a> <i class="fa fa-terminal" aria-hidden="true"></i>
  </a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="">
		<i class="fa fa-fw fa-home"></i>
	</a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/index.xml" title="Subscribirte">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>

<li class="icon">
	<a href="mailto:antoniomt.moon@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>



<li class="icon">
	<a href="https://bitbucket.org/MoonAntonio" title="Bitbucket">
		<i class="fa fa-fw fa-bitbucket"></i>
	</a>
</li>







<li class="icon">
	<a href="https://github.com/MoonAntonio" title="GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>

























<li class="icon">
	<a href="https://trello.com/antoniomoon" title="Trello">
		<i class="fa fa-fw fa-trello"></i>
	</a>
</li>

<li class="icon">
	<a href="https://gitlab.com/MoonAntonio" title="Gitlab">
		<i class="fa fa-fw fa-gitlab"></i>
	</a>
</li>


		</ul>
	</nav>
</header>


	<div class="content">
	<article class="feature-image">
		<header style="background-image: url('https://moonantonio.github.io/img/bg.png')">
			<h1 class="title">WebClient gestor de conexiones Unity3D</h1>
		</header>

		<section class="post-content">
			

<p>WebClient es un componente del lado del cliente, un modelo distribuido de aplicaciones de niveles múltiples utilizado para crear y desarrollar aplicaciones empresariales. Los componentes del lado del cliente son típicamente aplicaciones de computadora que se <strong>ejecutan en la computadora de un usuario y se conectan a un servidor</strong>. Estos componentes realizan operaciones en el lado del cliente, ya que pueden necesitar acceso a la información disponible solo en el lado del cliente, como la entrada del usuario, o porque el servidor carece de la potencia de procesamiento necesaria en tales operaciones.</p>

<hr />

<h1 id="que-es-un-gestor-de-conexiones">¿Que es un gestor de conexiones?</h1>

<p>Un gestor de conexiones, simplemente es un <strong>manager para controlar las conexiones ya sea webs u otros</strong>. Aqui voy a explicar, en que consiste un gestor de conexiones basico, para controlar la descarga de un archivo con solo una url. Este ejemplo, no es para ver los secretos ocultos de los protocolos, ni las limitaciones de plataformas, unicamente para comprobar que desde Unity3D se pueden gestionar conexiones https.</p>

<p><center><img src="/img/Dev/webclient01.png" alt="001" /></center></p>

<hr />

<h1 id="como-empezar">¿Como empezar?</h1>

<p>Primero vamos a crear un nuevo proyecto en Unity3D, yo lo llamare Gestor Conexiones Project. Ahora creare una <strong>serie de carpetas para almazenar</strong> los assets que vamos a usar.</p>

<p><center><img src="/img/Dev/webclient02.png" alt="002" /></center></p>

<p>Despues, como siempre, una escena llamada <strong>Alexandria</strong> e importare los assets que voy a usar.</p>

<p>En la escena, vamos a crear una <strong>nueva estructura para la UI</strong>.</p>

<p><center><img src="/img/Dev/webclient03.png" alt="003" /></center></p>

<p>En la base, crearemos la imagen de fondo, un panel que gestionara el contenido principal y otro que nos servira como un popup. Los dos paneles tienen que tener un canvasGroup.</p>

<p>Despues, <strong>necesitaremos 3 botones</strong>, uno para iniciar la descarga, otro para cancelarla y por ultimo uno para comprobar el archivo descargado. Tambien colocaremos una barra de progreso, para ver el progreso de la descarga y para finalizar dos textos, uno controlara la velocidad de descarga y otro el porcentaje de descarga.</p>

<p><center><img src="/img/Dev/webclient04.png" alt="004" /></center></p>

<p>Ahora en un gameobject vacio, agregaremos un script llamado, <strong>LinkBehaviour</strong>, este script, controlara la descarga.</p>

<p><center><img src="/img/Dev/webclient05.png" alt="005" /></center></p>

<hr />

<h1 id="picando-codigo">Picando codigo</h1>

<p>Un behavior, es la manera de extender un custom element para <strong>compartir el código entre diferentes componentes</strong>. Esta manera de compartir código permite añadir nuevas características al componente que se este desarrollando utilizando lo que otro desarrollador haya realizado en un componente totalmente distinto.</p>

<p><center><img src="/img/Dev/webclient06.png" alt="006" /></center></p>

<p>Por ello, se nuestro script se llama <strong>LinkBehaviour</strong>. Agregaremos algunas variables para ir iniciando(Para poder usar el tipo <strong>Slider</strong> tienes que importar la libreria UnityEngine.UI).</p>

<hr />

<pre><code class="language-C#">#region Librerias
using UnityEngine;
using UnityEngine.UI;
#endregion

namespace MoonAntonio
{
    /// &lt;summary&gt;
    /// &lt;para&gt;Componente central del gestor de conexiones.&lt;/para&gt;
    /// &lt;/summary&gt;
    public class LinkBehaviour : MonoBehaviour 
    {
        #region Variables Publicas
        public Slider progressBar;
        public bool UsarNombreOriginal = true;
        public string newNombreArchivo = &quot;x.zip&quot;;
        public bool onStart = false;
        #endregion

        #region Variables Privadas
        private string uri;
        #endregion
    }
}
</code></pre>

<hr />

<p>Ahora, usaremos esas variables creadas, en el metodo Start(), vamos a iniciarlo reseteando nuestra barra de progreso, asignaremos la url de descarga y realizaremos algunas comprobaciones para futuras caracteristicas.</p>

<hr />

<pre><code class="language-C#">#region Inicializadores
    private void Start()
    {
        // Establecer el valor maximo de la barra de progreso(Slider de UI) en 100(%)
        if (progressBar.maxValue != 100f) progressBar.maxValue = 100f;

        // Inicializar a 0
        progressBar.value = 0;

        // Asignar Uri
        uri = downloadUrl;

        // Usar el nombre original del archivo descargado
        if (UsarNombreOriginal) newNombreArchivo = Path.GetFileName(uri);

        // Comprobar si existe el directorio
        DirectoryInfo df = new DirectoryInfo(savePath);
        if (!df.Exists) Directory.CreateDirectory(savePath);


        if (onStart) DescargarArchivo();
    }
#endregion
</code></pre>

<hr />

<p>Al realizar la siguientes comprobaciones, os saldran errores, esto es normal, ya que es necesario crear unas nuevas variables y metodos. Tambien tendremos que llamar a unas librerias de system.</p>

<hr />

<pre><code class="language-C#">#region Librerias
using UnityEngine;
using UnityEngine.UI;
using System.IO;
using System;
#endregion
</code></pre>

<hr />

<pre><code class="language-C#">public string downloadUrl = string.Empty;
public string savePath = string.Empty;
</code></pre>

<hr />

<pre><code class="language-C#">#region API
public void DescargarArchivo(){}
#endregion
</code></pre>

<hr />

<p>De este modo, tendremos un metodo publico, con el que poder acceder para descargar nuestro archivo. Siempre desde una url y con una ruta de descarga local.</p>

<p><center><img src="/img/Dev/webclient07.png" alt="007" /></center></p>

<p>Ahora, tenemos que generar algunas variables nuevas.</p>

<hr />

<pre><code class="language-C#">public GameObject btnDescargaFinalizada;
public GameObject btnIniciarDescarga;
private bool isCancelado;
private bool isDescargando;
private WebClient client;
public bool dataPathPersistente = false;
</code></pre>

<hr />

<pre><code class="language-C#">#region API
    public void DescargarArchivo()
    {
        // Desactivamos la posibilidad de llamar de nuevo al metodo
        btnIniciarDescarga.SetActive(false);

        // Reseteamos la descarga y inicializamos el objeto
        isCancelado = false;
        client = new WebClient();

        // Comprobamos la persistencia para prevenir problemas futuros
        if (!dataPathPersistente)
            client.DownloadFileAsync(new System.Uri(downloadUrl), savePath + &quot;/&quot; + newNombreArchivo);
        else
            client.DownloadFileAsync(new System.Uri(uri), Application.persistentDataPath + &quot;/&quot; + newNombreArchivo);

        // Iniciamos la descarga y nos subscribimos a los eventos de WebClient()
        isDescargando = true;
        client.DownloadProgressChanged += new DownloadProgressChangedEventHandler(DescargaProgreso);
        client.DownloadFileCompleted += new System.ComponentModel.AsyncCompletedEventHandler(DescargaCompletada);
    }
#endregion
</code></pre>

<hr />

<p>Recordar, que hay que importar la libreria using System.Net;. Este metodo, desactiva el boton de iniciar descarga, para asi no volver a generar la llamada. Luego inicia un nuevo objeto de tipo webclient y crea unas reglas de prototipo para no tener problemas despues. Por ultimo, se subscribe a los eventos de client, para tener acceso al progreso de la descarga y a su finalizacion.</p>

<p>Ahora, hay que realizar los metodos de las subscripciones a los eventos de WebClient. Crearemos las variables que nos faltan.</p>

<hr />

<pre><code class="language-C#">private bool isTerminado;
private float progreso;
private string bytes;
</code></pre>

<hr />

<pre><code class="language-C#">#region Eventos
    protected void DescargaCompletada(object sender, System.ComponentModel.AsyncCompletedEventArgs e)
    {
        if (isCancelado)
        {
            Debug.Log(&quot;Cancelado.&quot;);
            isDescargando = false;
            isTerminado = true;
        }
        else
        {
            if (e.Error == null)
            {
                Debug.Log(&quot;Completado&quot;);
                isDescargando = false;
                isTerminado = true;
            }
            else
                Debug.Log(e.Error.ToString());
        }
    }

    protected void DescargaProgreso(object sender, DownloadProgressChangedEventArgs e)
    {
        progreso = (e.BytesReceived * 100 / e.TotalBytesToReceive);
        bytes = e.BytesReceived / 1000 + &quot; / &quot; + e.TotalBytesToReceive / 1000;
    }
#endregion
</code></pre>

<hr />

<p>En primer metodo, comprueba si se ha cancelado la descarga o si no. El segundo le asigna a las variables los datos de los bytes recibidos y del progreso actual.
Como recibimos en bytes, realizo la siguiente operacion para pasar los valores.</p>

<p><center><img src="/img/Dev/webclient08.png" alt="008" /></center></p>

<hr />

<p>Ahora vamos a crear dos metodos publicos en la zona de API, para carga el nivel y para cancelar la descarga. Tambien un metodo privado para autocancelar todo si se desabilita el script.</p>

<hr />

<pre><code class="language-C#">public void CargarNivel(string name)
{
    UnityEngine.SceneManagement.SceneManager.LoadScene(name);
}

public void CancelarDescarga()
{
    isCancelado = true;
    if (client != null)
    {
        client.CancelAsync();
    }

    btnIniciarDescarga.SetActive(true);
}

private void OnDisable()
{
    isCancelado = true;
    if (client != null) client.CancelAsync();
}
</code></pre>

<hr />

<pre><code class="language-C#">#region Actualizadores
    private void Update()
    {
        if (isDescargando)
        {
            progressBar.value = progreso;
            progressText.text = progreso.ToString() + &quot;% &quot;;

            if (isMostrarBytes) bytesText.text = &quot;Recibido : &quot; + bytes + &quot; kb&quot;;
        }


        if (isTerminado)
        {
            if (isCancelado)
            {
                bytesText.text = &quot;Cancelado&quot;;
                progressText.text = &quot;0 %&quot;;
                isTerminado = false;
            }
            else
            {
                if (!btnDescargaFinalizada.activeSelf)
                {
                    btnDescargaFinalizada.SetActive(true);
                    btnIniciarDescarga.SetActive(false);
                }
                bytesText.text = &quot;Recibido : &quot; + &quot;Completado&quot;;
                progressText.text = &quot;100 %&quot;;
            }
        }

    }
#endregion
</code></pre>

<hr />

<p>ya solo queda, asignar los datos necesarios y los metodos a los botones y vereis como inicia la descarga. En el repositorio de github dejare un custom inspector y la funcionalidad de los canvasgroup por si a alguien le interesa.</p>

<p><center><img src="/img/Dev/webclient09.gif" alt="009" /></center></p>

<p><center><a href="https://github.com/MoonAntonio/GestorConexiones" class="button">Repositorio</a></center></p>

<p>.\Moon</p>


			

			
				<hr>
				

<h3>Relacionado</h3>
<ul>
	
	<li><a href="/post/2018/comun/004/">¿Qué pruebas debemos hacerle a nuestro videojuego?</a></li>
	
	<li><a href="/post/2018/dev/003/">Unity3D Plugins ¿Que son?</a></li>
	
	<li><a href="/post/2018/dev/002/">ScriptableObjects</a></li>
	
	<li><a href="/post/2018/dev/001/">MonoBehavior en Unity</a></li>
	
	<li><a href="/post/2017/dev/014/">MVC simplificado.</a></li>
	
</ul>

			
		</section>
	</article>
	</div>

	<footer class="site-footer">
	<p class="text">&copy; 2018 - Moon Antonio</p>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89564434-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
